#!/bin/bash
# tests/mcp_tests/run_ssh_exploitation_debug_test.sh
# Run the SSH exploitation debug test inside the agents container.
#
# Usage:
#   ./run_ssh_exploitation_debug_test.sh
#   KEEP_SESSION=true ./run_ssh_exploitation_debug_test.sh
#   SLOW_THRESHOLD_SECONDS=3 PERF_TOP_N=30 ./run_ssh_exploitation_debug_test.sh

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
TARGET_HOST="${TARGET_HOST:-automotive-testbed}"

detect_shared_network() {
    local preferred="vt-saiber-network"
    local candidate=""

    if docker network inspect "$preferred" >/dev/null 2>&1; then
        echo "$preferred"
        return 0
    fi

    candidate=$(docker network ls --format '{{.Name}}' | grep -E '(^|_)vt-saiber-network$' | head -n1 || true)
    if [ -n "$candidate" ]; then
        echo "$candidate"
        return 0
    fi

    candidate=$(docker network ls --format '{{.Name}}' | grep -E 'vt[-_]?saiber.*network' | head -n1 || true)
    if [ -n "$candidate" ]; then
        echo "$candidate"
        return 0
    fi

    return 1
}

if ! SHARED_NETWORK="$(detect_shared_network)"; then
    echo "‚ùå Could not find a VT-SaiBER shared network."
    echo "   Start stack first: docker compose up -d"
    exit 1
fi

echo "======================================"
echo "üîê SSH EXPLOITATION DEBUG TEST"
echo "   automotive-testbed via MCP bridge"
echo "======================================"

echo ""
echo "üîç Checking container status..."

AGENTS_RUNNING=$(docker ps --filter "name=vt-saiber-agents" --filter "status=running" -q)
MSF_RUNNING=$(docker ps --filter "name=vt-saiber-msf-mcp" --filter "status=running" -q)
TESTBED_RUNNING=$(docker ps --filter "name=automotive-testbed" --filter "status=running" -q)

if [ -z "$AGENTS_RUNNING" ]; then
    echo "‚ùå vt-saiber-agents not running. Start with: docker compose up -d agents"
    exit 1
fi

if [ -z "$MSF_RUNNING" ]; then
    echo "‚ùå vt-saiber-msf-mcp not running. Start with: docker compose up -d msf-mcp"
    exit 1
fi

if [ -z "$TESTBED_RUNNING" ]; then
    echo "‚ö†Ô∏è  automotive-testbed container not running."
    echo "   Start it with: ./scripts/testbed/setup_testbed.sh"
    echo "   The test will still run but ssh_login will fail to connect."
    echo ""
fi

echo "‚úÖ Core containers running"

if [ -n "$TESTBED_RUNNING" ]; then
    ON_NETWORK=$(docker inspect automotive-testbed \
        --format '{{range $k,$v := .NetworkSettings.Networks}}{{$k}} {{end}}' 2>/dev/null \
        | grep -c -- "$SHARED_NETWORK" || true)

    if [ "$ON_NETWORK" -eq 0 ]; then
        echo "‚ö†Ô∏è  automotive-testbed is not on $SHARED_NETWORK."
        echo "   Connecting it now..."
        docker network connect "$SHARED_NETWORK" automotive-testbed 2>/dev/null || true
        RECHECK=$(docker inspect automotive-testbed \
            --format '{{range $k,$v := .NetworkSettings.Networks}}{{$k}} {{end}}' 2>/dev/null \
            | grep -c -- "$SHARED_NETWORK" || true)
        if [ "$RECHECK" -eq 0 ]; then
            echo "‚ùå Failed to attach automotive-testbed to $SHARED_NETWORK"
            exit 1
        fi
        echo "   Connected to $SHARED_NETWORK."
    else
        echo "‚úÖ automotive-testbed is on $SHARED_NETWORK"
    fi

    echo ""
    echo "üîé Checking target reachability from msf-mcp..."
    if docker exec vt-saiber-msf-mcp sh -lc "getent hosts '$TARGET_HOST' >/dev/null 2>&1"; then
        echo "‚úÖ msf-mcp resolves target hostname: $TARGET_HOST"
    else
        echo "‚ö†Ô∏è  msf-mcp cannot resolve '$TARGET_HOST'. Falling back to testbed IP on $SHARED_NETWORK."
        TARGET_IP=$(docker network inspect "$SHARED_NETWORK" \
            --format '{{range $id,$c := .Containers}}{{if eq $c.Name "automotive-testbed"}}{{$c.IPv4Address}}{{end}}{{end}}' \
            2>/dev/null | cut -d/ -f1)
        if [ -z "$TARGET_IP" ]; then
            echo "‚ùå Could not determine automotive-testbed IP on $SHARED_NETWORK"
            exit 1
        fi
        TARGET_HOST="$TARGET_IP"
        echo "‚úÖ Using IP target: $TARGET_HOST"
    fi

    if docker exec vt-saiber-msf-mcp sh -lc "nc -vz -w 3 '$TARGET_HOST' 22 >/dev/null 2>&1"; then
        echo "‚úÖ msf-mcp can reach $TARGET_HOST:22"
    else
        echo "‚ùå msf-mcp cannot reach $TARGET_HOST:22"
        echo "   This will cause very slow ssh_login attempts and no sessions."
        exit 1
    fi
fi

echo ""
echo "üìã Copying debug test script to container..."

docker exec vt-saiber-agents mkdir -p /app/tests/mcp_tests

docker cp "$SCRIPT_DIR/test_ssh_exploitation_debug.py" \
    vt-saiber-agents:/app/tests/mcp_tests/test_ssh_exploitation_debug.py

echo ""
echo "üöÄ Running SSH exploitation debug test..."
if [ "${KEEP_SESSION:-false}" = "true" ]; then
    echo "   (KEEP_SESSION=true ‚Äî session will be left open after test)"
fi
echo "   SLOW_THRESHOLD_SECONDS=${SLOW_THRESHOLD_SECONDS:-5}"
echo "   PERF_TOP_N=${PERF_TOP_N:-20}"
echo "======================================"
echo ""

docker exec -t \
    -e KEEP_SESSION="${KEEP_SESSION:-false}" \
    -e SLOW_THRESHOLD_SECONDS="${SLOW_THRESHOLD_SECONDS:-5}" \
    -e PERF_TOP_N="${PERF_TOP_N:-20}" \
    -e TARGET_HOST="${TARGET_HOST}" \
    vt-saiber-agents \
    python3 -u /app/tests/mcp_tests/test_ssh_exploitation_debug.py

TEST_EXIT=$?

echo ""
if [ $TEST_EXIT -eq 0 ]; then
    echo "======================================"
    echo "‚úÖ SSH EXPLOITATION DEBUG TEST PASSED"
    echo "======================================"
else
    echo "======================================"
    echo "‚ùå SSH EXPLOITATION DEBUG TEST FAILED"
    echo "======================================"
fi

exit $TEST_EXIT
